{% extends 'ehr/base.html' %}

{% block title %}{% if object %}Edit{% else %}Create{% endif %} Report{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>{% if object %}Edit{% else %}Create{% endif %} Report</h2>
    </div>
    <div class="card-body">
        <form method="post" id="reportForm">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                    {{ form.title }}
                    {% if form.title.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.title.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.report_type.id_for_label }}" class="form-label">{{ form.report_type.label }}</label>
                    {{ form.report_type }}
                    {% if form.report_type.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.report_type.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mb-3">
                <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                {{ form.description }}
                {% if form.description.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.description.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="d-flex justify-content-between">
                <a href="{% if object %}{% url 'report_detail' object.pk %}{% else %}{% url 'report_list' %}{% endif %}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="bi bi-save"></i> {% if object %}Update{% else %}Create{% endif %} Report
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('reportForm');
        const submitBtn = document.getElementById('submitBtn');
        
        // Add Bootstrap validation classes
        const inputs = form.querySelectorAll('input, select, textarea');
        
        inputs.forEach(input => {
            input.classList.add('form-control');
            
            if (input.id === 'id_description') {
                input.rows = 3;
            }
            
            // Check for existing errors
            if (input.classList.contains('is-invalid')) {
                input.classList.add('is-invalid');
            }
        });
        
        // Form submission handler
        form.addEventListener('submit', function(e) {
            // Validate form before submission
            let isValid = true;
            
            inputs.forEach(input => {
                if (!input.value && input.required) {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert('Please fill in all required fields.');
            } else {
                // Disable button to prevent double submission
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            }
        });
    });
</script>
{% endblock %}